# Please do not edit this file.
# More information under https://docs.ionos.space/docs/github-actions-customization/
# version: 2022-07-21

name: "Deploy to IONOS"

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
      project-id:
        required: true
        type: string
      branch-id:
        required: true
        type: string
      deployment-ids:
        required: true
        type: string
  push:
    paths:
      - ./.github/workflows/deploy-to-ionos.yaml

jobs:
  deploy-to-ionos:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
    strategy:
      matrix:
        deployment-id: ${{ fromJson(inputs.deployment-ids) }}
    steps:
      - name: Update deployment status
        uses: ionos-deploy-now/project-action@v1
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: ${{ inputs.project-id }}
          branch-id: ${{ inputs.branch-id }}
          deployment-id: ${{ matrix.deployment-id }}
          action: update-status
          status: in_progress

      - name: Retrieve stored deployment
        uses: ionos-deploy-now/artifact-action@v1
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: ${{ inputs.project-id }}
          branch-id: ${{ inputs.branch-id }}
          version: ${{ inputs.version }}
          action: download

      - name: Fetch deployment info
        uses: ionos-deploy-now/project-action@v1
        id: deployment
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: ${{ inputs.project-id }}
          branch-id: ${{ inputs.branch-id }}
          deployment-id: ${{ matrix.deployment-id }}
          action: retrieve-info

      - name: Render templates
        uses: ionos-deploy-now/template-renderer-action@v2
        id: template
        with:
          deployment-id: ${{ matrix.deployment-id }}
          data: "[${{ steps.deployment.outputs.template-variables }}, ${{ toJson(secrets) }}]"
          input-directory: deployment
          output-directory: deployment
          intermediate-data-file: deployment/.template-renderer-data

      - name: Test SSH Connection to IONOS
        run: |
          mkdir -p ~/.ssh
          echo "$IONOS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan access-5017534069.app-ionos.space >> ~/.ssh/known_hosts
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.IONOS_SSH_USER }}@access-5017534069.app-ionos.space "echo SSH Connection Successful"
        env:
          IONOS_SSH_KEY: ${{ secrets.IONOS_SSH_KEY }}

      - name: Deploy to IONOS
        uses: ionos-deploy-now/deploy-to-ionos-action@v2
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: ${{ inputs.project-id }}
          branch-id: ${{ inputs.branch-id }}
          deployment-id: ${{ matrix.deployment-id }}
          deployment-info: ${{ steps.deployment.outputs.info }}
          ssh-user: ${{ secrets.IONOS_SSH_USER }}
          ssh-key: ${{ secrets.IONOS_SSH_KEY }}
